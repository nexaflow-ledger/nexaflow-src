name: Build Executables

on:
  # Trigger on version tags (e.g., v0.9.0, v1.0.0)
  push:
    tags:
      - "v*"
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag name for the release (leave empty for dev build)"
        required: false
        default: ""

permissions:
  contents: write   # needed to create GitHub Releases

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ────────────────────────────────────────────────────────────
  # Build Node executable (CLI)
  # ────────────────────────────────────────────────────────────
  build-node:
    name: "Node — ${{ matrix.os_label }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            os_label: Linux
            artifact: nexaflow-node-linux-amd64
            ext: ""
          - os: macos-latest
            os_label: macOS
            artifact: nexaflow-node-macos-arm64
            ext: ""
          - os: windows-latest
            os_label: Windows
            artifact: nexaflow-node-windows-amd64
            ext: ".exe"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install cython>=3.0.0
          pip install -e "."
          pip install pyinstaller

      - name: Build Cython extensions
        run: python setup.py build_ext --inplace

      - name: Build node executable
        run: pyinstaller nexaflow_node.spec --noconfirm --clean

      - name: Verify executable
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            ./dist/nexaflow-node.exe --help || true
          else
            chmod +x ./dist/nexaflow-node
            ./dist/nexaflow-node --help || true
          fi

      - name: Package artifact
        shell: bash
        run: |
          mkdir -p staging
          if [ "${{ runner.os }}" = "Windows" ]; then
            cp dist/nexaflow-node.exe "staging/${{ matrix.artifact }}.exe"
          else
            cp dist/nexaflow-node "staging/${{ matrix.artifact }}"
          fi
          # Bundle the example config
          cp nexaflow.example.toml staging/ 2>/dev/null || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: staging/
          retention-days: 30

  # ────────────────────────────────────────────────────────────
  # Build GUI executable (PyQt6 desktop app)
  # ────────────────────────────────────────────────────────────
  build-gui:
    name: "GUI — ${{ matrix.os_label }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            os_label: Linux
            artifact: nexaflow-gui-linux-amd64
            ext: ""
          - os: macos-latest
            os_label: macOS
            artifact: nexaflow-gui-macos-arm64
            ext: ""
          - os: windows-latest
            os_label: Windows
            artifact: nexaflow-gui-windows-amd64
            ext: ".exe"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Linux: install system Qt/GL dependencies for PyQt6
      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev \
            libglib2.0-0 \
            libegl1 \
            libxkbcommon0 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libdbus-1-3 \
            libfontconfig1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install cython>=3.0.0
          pip install -e ".[gui]"
          pip install pyinstaller

      - name: Build Cython extensions
        run: python setup.py build_ext --inplace

      - name: Build GUI executable
        run: pyinstaller nexaflow_gui.spec --noconfirm --clean

      - name: Package artifact
        shell: bash
        run: |
          mkdir -p staging

          if [ "${{ runner.os }}" = "macOS" ]; then
            # Bundle the .app directory
            if [ -d "dist/NexaFlow.app" ]; then
              cd dist && zip -r "../staging/${{ matrix.artifact }}.app.zip" NexaFlow.app && cd ..
            else
              cp dist/nexaflow-gui "staging/${{ matrix.artifact }}"
            fi
          elif [ "${{ runner.os }}" = "Windows" ]; then
            cp dist/nexaflow-gui.exe "staging/${{ matrix.artifact }}.exe"
          else
            cp dist/nexaflow-gui "staging/${{ matrix.artifact }}"
          fi

          # Bundle the example config
          cp nexaflow.example.toml staging/ 2>/dev/null || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: staging/
          retention-days: 30

  # ────────────────────────────────────────────────────────────
  # Create GitHub Release (only on tag push)
  # ────────────────────────────────────────────────────────────
  release:
    name: Create GitHub Release
    needs: [build-node, build-gui]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets/

      - name: Prepare release files
        run: |
          mkdir -p release-final
          # Flatten all artifacts into one directory
          for dir in release-assets/*/; do
            cp -r "$dir"* release-final/ 2>/dev/null || true
          done
          echo "=== Release files ==="
          ls -lhR release-final/

      - name: Generate checksums
        working-directory: release-final
        run: |
          sha256sum * > SHA256SUMS.txt 2>/dev/null || shasum -a 256 * > SHA256SUMS.txt
          echo "=== SHA256 Checksums ==="
          cat SHA256SUMS.txt

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "NexaFlow ${{ github.ref_name }}"
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          generate_release_notes: true
          files: release-final/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
